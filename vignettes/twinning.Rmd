---
title: "Twinning"
author: "Richel J.C. Bilderbeek"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Twinning}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

`pirouette` has the option to investigate the error BEAST2 makes
on a twin tree. A twin tree is a tree with the same topology as the
original phylogeny, yet where the branch lengths follow a birth-death
branch length distribution.

Twinning is useful to separate the effect of an unknown tree 
prior (i.e. speciation model) on a phylogeny's shape from the 
noise (the minimal error) made by BEAST2.

In this example, the following tree is used:

```{r}
phylogeny <- ape::read.tree(text = "((A:1, B:1):1, (C:1, D:1):1);")
ape::plot.phylo(phylogeny, main = "The True Phylogeny")
```

This phylogeny follows a speciation model unknown to BEAST2, as two
speciation events happened at exactly the same time. Such a phylogeny
will have a likelihood of zero for all of the BEAST2 tree priors.

Twinning:

```{r}
twinning_params <- pirouette::create_twinning_params(
  rng_seed = 42
)
```

```{r}
alignment_params = pirouette::create_alignment_params(
  root_sequence = pirouette::create_blocked_dna(length = 100),
  mutation_rate = 1.0 / beautier::get_crown_age(phylogeny)
)
```

We select our inference models in two ways:

  1. Using the generative model: we use the same site and clock model
     the alignment was created with. We do have to specify a BEAST2
     tree prior that is closest to what we think generated the phylogeny
  2. (for non-Windows users only) Using the inference model that
     has the most evidence (also: marginal likelihood) from a set of inference
     models. In this example, we pick all combinations of the one
     correct site model, the one correct clock model and two tree
     priors.

```{r}
model_select_params <- list()

gen_model_select_param <- pirouette::create_gen_model_select_param(
  alignment_params = alignment_params,
  tree_prior = beautier::create_bd_tree_prior()
)
model_select_params[[1]] <- gen_model_select_param 
  
if (rappdirs::app_dir()$os != "win") {
  best_model_select_param <- pirouette::create_best_model_select_param(
    site_models = list(beautier::create_jc69_site_model()),
    clock_models = list(beautier::create_strict_clock_model()),
    tree_priors = list(
      beautier::create_yule_tree_prior(),
      beautier::create_bd_tree_prior()  
    ),
    epsilon = 0.1
  )
  model_select_params[[2]] <- best_model_select_param 
}
```

```{r}
inference_param <- pirouette::create_inference_param(
  mcmc = beautier::create_mcmc(chain_length = 2000, store_every = 1000),
  rng_seed = 42
)
```

Run:

```{r}
# ISSUE #41: Richel TODO: make pir_run work
# df <- pirouette::pir_run(
#   phylogeny = phylogeny,
#   twinning_params = twinning_params,
#   alignment_params = alignment_params,
#   model_select_params = model_select_params,
#   inference_param = inference_param 
# )
```

Show as a table:

```{r}
# depends on ISSUE #41
# knitr::kable(df)
```

Show as a figure:

```{r fig.width=7, fig.height=7}
# depends on ISSUE #41
# pirouette::pir_plot(df)
```

## Appendix

### True tree

See true tree again:

```{r}
ape::plot.phylo(phylogeny, main = "The True Phylogeny")
```

See the alignment generated from the true tree:

```{r}
# TODO
```

See the posterior trees generated from the true alignment, for the generative model:

```{r}
# TODO
```

See the posterior trees generated from the true alignment, for the model with the most evidence:

```{r}
# TODO
```

See the posterior parameter estimates generated from the true alignment, for the generative model:

```{r}
# TODO
```

See the posterior parameter estimates generated from the true alignment, for the model with the most evidence:

```{r}
# TODO
```

### Twin tree

See the twin tree:

```{r}
#ape::plot.phylo(ape::read.tree(twinning_params$twin_tree_filename), main = "The Twin Tree")
```

See the alignment generated from the twin tree:

```{r}
# TODO
```

See the posterior trees generated from the twin alignment, for the generative model:

```{r}
# TODO
```

See the posterior trees generated from the twin alignment, for the model with the most evidence:

```{r}
# TODO
```

See the posterior parameter estimates generated from the true alignment, for the generative model:

```{r}
# TODO
```

See the posterior parameter estimates generated from the true alignment, for the model with the most evidence:

```{r}
# TODO
```
